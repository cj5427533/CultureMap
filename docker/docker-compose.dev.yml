# version은 더 이상 필요하지 않습니다 (최신 Docker Compose는 자동 감지)

services:
  # MySQL 데이터베이스 (개발용)
  mysql:
    image: mysql:8.0
    container_name: culturemap-mysql-dev
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: 1234
      MYSQL_DATABASE: culturemap
      TZ: Asia/Seoul
    ports:
      - "3309:3306"  # 3308 포트 충돌 방지를 위해 3309로 변경
    volumes:
      - mysql_dev_data:/var/lib/mysql
    networks:
      - culturemap-dev-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p1234"]
      interval: 10s
      timeout: 5s
      retries: 5

  # 백엔드 서버 (개발 모드 - 소스 코드 볼륨 마운트, Hot Reload)
  backend:
    build:
      context: ..
      dockerfile: docker/Dockerfile.dev
    container_name: culturemap-backend-dev
    restart: unless-stopped
    env_file:
      - ../.env
    environment:
      SPRING_PROFILES_ACTIVE: dev
      DB_URL: jdbc:mysql://mysql:3306/culturemap?useSSL=false&serverTimezone=Asia/Seoul&characterEncoding=UTF-8&allowPublicKeyRetrieval=true
      # 개발 모드에서는 MySQL 포트가 3309로 노출되지만, 컨테이너 간 통신은 3306 사용
      DB_USERNAME: root
      DB_PASSWORD: 1234
      JWT_SECRET: culturemap-secret-key-for-jwt-token-generation-please-change-in-production
      KAKAO_REST_API_KEY: ${KAKAO_REST_API_KEY:-e098b0e671f2a7f914744bb2c8aa296f}
      CORS_ALLOWED_ORIGINS: http://localhost:5173
    ports:
      - "8080:8080"
    volumes:
      # 소스 코드를 볼륨으로 마운트하여 코드 변경 시 즉시 반영
      - ../src:/app/src
      - ../build.gradle:/app/build.gradle:ro
      - ../settings.gradle:/app/settings.gradle:ro
      - ../gradlew:/app/gradlew:ro
      - ../gradle:/app/gradle:ro
      - ../history_image:/app/history_image
      # 빌드 결과물 캐시 (빌드 속도 향상)
      - backend_build:/app/build
      - gradle_cache:/root/.gradle
    depends_on:
      mysql:
        condition: service_healthy
    networks:
      - culturemap-dev-network
    command: >
      sh -c "
        ./gradlew bootRun --no-daemon --continuous
      "

  # 프론트엔드 서버 (개발 모드 - Vite 개발 서버, Hot Reload)
  frontend:
    build:
      context: ../frontend
      dockerfile: Dockerfile.dev
    container_name: culturemap-frontend-dev
    restart: unless-stopped
    env_file:
      - ../.env
    environment:
      VITE_API_BASE_URL: /api
      VITE_KAKAO_MAP_API_KEY: 488785b728092d9a04e6ca1547f80412
    ports:
      - "5173:5173"
    volumes:
      # 소스 코드를 볼륨으로 마운트하여 코드 변경 시 즉시 반영 (Hot Reload)
      - ../frontend/src:/app/src
      - ../frontend/public:/app/public
      - ../frontend/index.html:/app/index.html
      - ../frontend/vite.config.ts:/app/vite.config.ts
      - ../frontend/tsconfig.json:/app/tsconfig.json
      - ../frontend/tsconfig.app.json:/app/tsconfig.app.json
      - ../frontend/tsconfig.node.json:/app/tsconfig.node.json
      - ../frontend/tailwind.config.js:/app/tailwind.config.js
      - ../frontend/postcss.config.js:/app/postcss.config.js
      - ../frontend/eslint.config.js:/app/eslint.config.js
      - ../frontend/package.json:/app/package.json
      # node_modules는 컨테이너 내부에 설치 (볼륨 제외로 변경)
      # - frontend_node_modules:/app/node_modules  # 주석 처리: 호환성 문제로 인해 제외
    depends_on:
      - backend
    networks:
      - culturemap-dev-network
    command: npm run dev -- --host

networks:
  culturemap-dev-network:
    driver: bridge

volumes:
  mysql_dev_data:
    driver: local
  backend_build:
    driver: local
  gradle_cache:
    driver: local
  # frontend_node_modules:
  #   driver: local  # 주석 처리: Vite 7 호환성 문제
