# í”„ë¡ íŠ¸ì—”ë“œ Dockerfile
# ë¹Œë“œ ë‹¨ê³„
FROM node:18-alpine AS build

WORKDIR /app

# ë¹Œë“œ ì‹œ í™˜ê²½ë³€ìˆ˜ë¥¼ ARGë¡œ ë°›ìŒ
ARG VITE_KAKAO_MAP_API_KEY
ARG VITE_API_BASE_URL=https://culturemap-api.fly.dev/api

# í™˜ê²½ë³€ìˆ˜ë¥¼ ë¹Œë“œ íƒ€ì„ì— ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ ENVë¡œ ì„¤ì •
ENV VITE_KAKAO_MAP_API_KEY=$VITE_KAKAO_MAP_API_KEY
ENV VITE_API_BASE_URL=$VITE_API_BASE_URL

# package.json ë³µì‚¬ ë° ì˜ì¡´ì„± ì„¤ì¹˜
COPY package*.json ./
RUN npm ci

# ì†ŒìŠ¤ ì½”ë“œ ë³µì‚¬ (.env.production í¬í•¨, ìˆìœ¼ë©´)
COPY . .

# .env íŒŒì¼ì´ ìˆìœ¼ë©´ ì œê±° (ì¶©ëŒ ë°©ì§€)
# .env.productionì´ ìš°ì„ ìˆœìœ„ë¥¼ ê°€ì§€ë„ë¡ í•¨
RUN if [ -f .env ]; then \
      echo "WARNING: .env file found, checking for conflicts..."; \
      if grep -q "VITE_KAKAO_MAP_API_KEY" .env; then \
        echo "WARNING: VITE_KAKAO_MAP_API_KEY found in .env, removing to avoid conflict"; \
        grep -v "VITE_KAKAO_MAP_API_KEY" .env > .env.tmp && mv .env.tmp .env || true; \
      fi; \
      if grep -q "VITE_API_BASE_URL" .env; then \
        echo "WARNING: VITE_API_BASE_URL found in .env, removing to avoid conflict"; \
        grep -v "VITE_API_BASE_URL" .env > .env.tmp && mv .env.tmp .env || true; \
      fi; \
    fi

# .env.production íŒŒì¼ í™•ì¸ ë° ìƒì„± (BOM ì œê±° í¬í•¨)
RUN echo "Checking for .env.production file..." && \
    ls -la .env* 2>/dev/null || echo "No .env files found" && \
    if [ -f .env.production ]; then \
      echo "Found existing .env.production file"; \
      echo "Removing UTF-8 BOM if present..."; \
      sed -i '1s/^\xEF\xBB\xBF//' .env.production 2>/dev/null || true; \
      echo "File contents:"; \
      cat .env.production; \
      echo ""; \
      echo "API Key extraction and validation:"; \
      API_KEY=$(grep -E "^VITE_KAKAO_MAP_API_KEY=" .env.production | sed 's/^VITE_KAKAO_MAP_API_KEY=//' | tr -d ' \r\n'); \
      if [ -z "$API_KEY" ]; then \
        echo "ERROR: Could not extract API key from .env.production"; \
        echo "Trying alternative extraction method..."; \
        API_KEY=$(cat .env.production | grep VITE_KAKAO_MAP_API_KEY | head -1 | sed 's/.*VITE_KAKAO_MAP_API_KEY=//' | tr -d ' \r\n'); \
        if [ -z "$API_KEY" ]; then \
          echo "ERROR: Still could not extract API key"; \
          echo "File content (hex dump):"; \
          hexdump -C .env.production | head -20; \
          exit 1; \
        fi; \
      fi; \
      echo "Extracted API Key length: ${#API_KEY}"; \
      echo "First 10 chars: ${API_KEY:0:10}..."; \
      if [ ${#API_KEY} -lt 30 ]; then \
        echo "ERROR: API Key is too short (${#API_KEY} chars). Minimum 30 required."; \
        echo "Current key: $API_KEY"; \
        exit 1; \
      else \
        echo "API Key length is valid"; \
      fi; \
      echo "Recreating .env.production without BOM..."; \
      echo "VITE_KAKAO_MAP_API_KEY=${API_KEY}" > .env.production && \
      echo "VITE_API_BASE_URL=${VITE_API_BASE_URL}" >> .env.production && \
      echo "Verifying recreated file:"; \
      cat .env.production; \
    else \
      echo ".env.production not found, creating from build args..."; \
      if [ -z "$VITE_KAKAO_MAP_API_KEY" ] || [ "$VITE_KAKAO_MAP_API_KEY" = "" ]; then \
        echo "ERROR: VITE_KAKAO_MAP_API_KEY is not set!"; \
        echo "Please either:"; \
        echo "  1. Create .env.production file with VITE_KAKAO_MAP_API_KEY=your_key"; \
        echo "  2. Use: fly deploy --build-arg VITE_KAKAO_MAP_API_KEY=your_key"; \
        exit 1; \
      else \
        echo "Build arg API Key length: ${#VITE_KAKAO_MAP_API_KEY}"; \
        if [ ${#VITE_KAKAO_MAP_API_KEY} -lt 30 ]; then \
          echo "ERROR: Build arg API Key is too short (${#VITE_KAKAO_MAP_API_KEY} chars)"; \
          exit 1; \
        fi; \
      fi; \
      echo "VITE_KAKAO_MAP_API_KEY=${VITE_KAKAO_MAP_API_KEY}" > .env.production && \
      echo "VITE_API_BASE_URL=${VITE_API_BASE_URL}" >> .env.production && \
      echo "Created .env.production:"; \
      cat .env.production; \
    fi && \
    echo "" && \
    echo "Final .env.production verification:" && \
    cat .env.production && \
    echo "" && \
    echo "Final API Key validation:" && \
    FINAL_KEY=$(grep -E "^VITE_KAKAO_MAP_API_KEY=" .env.production | sed 's/^VITE_KAKAO_MAP_API_KEY=//' | tr -d ' \r\n'); \
    echo "Length: ${#FINAL_KEY} characters" && \
    echo "First 10 chars: ${FINAL_KEY:0:10}..." && \
    if [ ${#FINAL_KEY} -lt 30 ]; then \
      echo "ERROR: Final API Key validation failed!"; \
      exit 1; \
    else \
      echo "Final API Key validation passed"; \
    fi

# ì• í”Œë¦¬ì¼€ì´ì…˜ ë¹Œë“œ
RUN echo "ğŸš€ Starting build..." && \
    npm run build && \
    echo "âœ… Build completed" && \
    echo "ğŸ” Verifying built files..." && \
    if [ -f dist/index.html ]; then \
      echo "âœ… dist/index.html exists"; \
      if grep -q "VITE_KAKAO_MAP_API_KEY" dist/assets/*.js 2>/dev/null; then \
        echo "âœ… API key found in built files"; \
      else \
        echo "âš ï¸ WARNING: API key not found in built files"; \
      fi; \
    fi


# í”„ë¡œë•ì…˜ ë‹¨ê³„
FROM nginx:alpine

# ë¹Œë“œëœ íŒŒì¼ì„ nginxë¡œ ë³µì‚¬
COPY --from=build /app/dist /usr/share/nginx/html

# nginx ì„¤ì • íŒŒì¼ ë³µì‚¬ (ì„ íƒì‚¬í•­)
COPY nginx.conf /etc/nginx/conf.d/default.conf

# í¬íŠ¸ ë…¸ì¶œ
EXPOSE 80

# nginx ì‹¤í–‰
CMD ["nginx", "-g", "daemon off;"]
