pipeline {
    agent any

    environment {
        // Docker 이미지 태그
        IMAGE_TAG = "${env.BUILD_NUMBER}"
        DOCKER_REGISTRY = "${env.DOCKER_REGISTRY ?: 'localhost:5000'}"
        
        // 프로젝트 이름
        PROJECT_NAME = 'culturemap'
        BACKEND_IMAGE = "${DOCKER_REGISTRY}/${PROJECT_NAME}-backend:${IMAGE_TAG}"
        FRONTEND_IMAGE = "${DOCKER_REGISTRY}/${PROJECT_NAME}-frontend:${IMAGE_TAG}"
        
        // Docker Compose 파일
        COMPOSE_FILE = 'docker/docker-compose.yml'
    }

    stages {
        stage('Checkout') {
            steps {
                echo '코드 체크아웃 중...'
                checkout scm
            }
        }

        stage('Build Backend') {
            steps {
                echo '백엔드 빌드 중...'
                script {
                    sh '''
                        cd ${WORKSPACE}
                        chmod +x gradlew
                        ./gradlew clean build -x test --no-daemon
                    '''
                }
            }
            post {
                success {
                    echo '백엔드 빌드 성공'
                }
                failure {
                    echo '백엔드 빌드 실패'
                    currentBuild.result = 'FAILURE'
                }
            }
        }

        stage('Build Frontend') {
            steps {
                echo '프론트엔드 빌드 중...'
                script {
                    sh '''
                        cd ${WORKSPACE}/frontend
                        npm ci
                        npm run build
                    '''
                }
            }
            post {
                success {
                    echo '프론트엔드 빌드 성공'
                }
                failure {
                    echo '프론트엔드 빌드 실패'
                    currentBuild.result = 'FAILURE'
                }
            }
        }

        stage('Docker Build') {
            steps {
                echo 'Docker 이미지 빌드 중...'
                script {
                    // 백엔드 이미지 빌드
                    sh """
                        docker build -t ${BACKEND_IMAGE} -t ${PROJECT_NAME}-backend:latest -f docker/Dockerfile .
                    """
                    
                    // 프론트엔드 이미지 빌드
                    sh """
                        cd ${WORKSPACE}/frontend
                        docker build -t ${FRONTEND_IMAGE} -t ${PROJECT_NAME}-frontend:latest \
                            --build-arg VITE_API_BASE_URL=\${VITE_API_BASE_URL:-http://localhost:8080/api} .
                    """
                }
            }
        }

        stage('Docker Push') {
            when {
                anyOf {
                    branch 'main'
                    branch 'master'
                }
            }
            steps {
                echo 'Docker 이미지 푸시 중...'
                script {
                    // Docker Registry에 푸시 (설정된 경우)
                    if (env.DOCKER_REGISTRY && env.DOCKER_REGISTRY != 'localhost:5000') {
                        sh """
                            docker push ${BACKEND_IMAGE}
                            docker push ${FRONTEND_IMAGE}
                            docker push ${PROJECT_NAME}-backend:latest
                            docker push ${PROJECT_NAME}-frontend:latest
                        """
                    } else {
                        echo 'Docker Registry가 설정되지 않아 푸시를 건너뜁니다.'
                    }
                }
            }
        }

        stage('Deploy') {
            when {
                anyOf {
                    branch 'main'
                    branch 'master'
                }
            }
            steps {
                echo '배포 중...'
                script {
                    sh """
                        cd ${WORKSPACE}
                        
                        # 기존 컨테이너 중지 및 제거
                        docker-compose -f ${COMPOSE_FILE} down || true
                        
                        # 환경 변수 파일 확인
                        if [ ! -f .env ]; then
                            echo '경고: .env 파일이 없습니다. 기본값을 사용합니다.'
                        fi
                        
                        # 새 컨테이너 시작
                        docker-compose -f ${COMPOSE_FILE} up -d --build
                        
                        # 컨테이너 상태 확인
                        sleep 10
                        docker-compose -f ${COMPOSE_FILE} ps
                    """
                }
            }
            post {
                success {
                    echo '배포 성공!'
                    // 헬스 체크
                    sh """
                        sleep 30
                        curl -f http://localhost:8080/api-docs || echo '백엔드 헬스 체크 실패'
                        curl -f http://localhost:80 || echo '프론트엔드 헬스 체크 실패'
                    """
                }
                failure {
                    echo '배포 실패'
                    currentBuild.result = 'FAILURE'
                }
            }
        }

        stage('Cleanup') {
            steps {
                echo '정리 중...'
                script {
                    // 오래된 이미지 정리 (선택사항)
                    sh """
                        docker image prune -f
                        # 오래된 빌드 이미지 제거 (최근 5개만 유지)
                        docker images ${PROJECT_NAME}-backend --format '{{.ID}}' | tail -n +6 | xargs -r docker rmi || true
                        docker images ${PROJECT_NAME}-frontend --format '{{.ID}}' | tail -n +6 | xargs -r docker rmi || true
                    """
                }
            }
        }
    }

    post {
        always {
            echo '파이프라인 완료'
            // 빌드 결과 정리
            cleanWs()
        }
        success {
            echo '✅ 빌드 및 배포 성공!'
        }
        failure {
            echo '❌ 빌드 또는 배포 실패'
            // 알림 전송 (이메일, 슬랙 등) 설정 가능
        }
    }
}
